pipeline {
    agent any

    environment {
        SCP_ADR = getAddressFromBranch(env.BRANCH_NAME)
        NPM_BUILD_PARAM = getParamFromBranch(env.BRANCH_NAME)
    }

    stages {

        stage ("Initialisation â³") {
            steps {
                echo "Environment: ${SCP_ADR}"
                sh '''
                    cd ${WORKSPACE}
                    chmod -R 755 ./fimafeng-front
                '''
            }
        }

        stage("Test ðŸ§ª") {
            steps {
                echo "Lancement des tests BACK"
                sh '''
                    cd ${WORKSPACE}/fimafeng-back/
                    mvn test
                '''

                echo "Lancement du backend"
                sh '''
                    cd ${WORKSPACE}/fimafeng-back/
                    export SERVER_PORT=8081
                    nohup java -jar ./target/*.jar ${SCP_ADR}: &
                    sleep 10
                '''
        
                echo "Lancement des tests FRONT"
                ansiColor('xterm') {
                    sh '''
                        cd ${WORKSPACE}/fimafeng-front
                        npm install
                        Xvfb :99 -screen 0 1280x1024x24 &
                        export DISPLAY=:99
                        npm run start:cicd &
                        for i in {1..30}; do
                            if curl -s http://localhost:3000 > /dev/null; then
                                break
                            fi
                            sleep 2
                        done
                        npm run test:cypress:local --no-color
                        kill $(lsof -t -i:3000)
                        '''
                }

                echo "ArrÃªt du backend"
                sh '''
                    kill $(lsof -t -i:8081)
                '''
            }
        }

        stage("Package ðŸ“¦") {
            steps {

                echo "Compilation du BACK"
                sh '''
                    cd ${WORKSPACE}/fimafeng-back
                    mvn clean install -DskipTests
                '''

                echo "Compilation du FRONT"
                sh '''
                    cd ${WORKSPACE}/fimafeng-front
                    npm install
                    npm install react-scripts --save
                    npm run ${NPM_BUILD_PARAM}
                '''

            }
        }

        stage("Deliver ðŸšš") {
            steps {
                echo "Livraison des fichiers"
                sh '''
                    cd ${WORKSPACE}
                    scp ./fimafeng-back/target/*.jar ${SCP_ADR}:
                    ssh ${SCP_ADR} rm -r ./build/
                    scp -r ./fimafeng-front/build/ ${SCP_ADR}:
                '''
            }
        }

        stage("Start ðŸš€") {
            steps {
                echo "DÃ©marrage des modules"

                echo "Mise Ã  jour du front"
                sh '''
                    ssh ${SCP_ADR} rm -r /var/www/html/*
                    ssh ${SCP_ADR} cp -r build/* /var/www/html/
                    ssh ${SCP_ADR} sh restart-front.sh
                    '''

                echo "Mise Ã  jour du back"
                script {
                    try {
                        def result = sh(script: 'ssh ${SCP_ADR} "pgrep java"', returnStdout: true).trim()
                        echo "result: [$result]"
                        if (result.size() != '') {
                            env.BACKEND_PID = result
                            sh (script: 'ssh ${SCP_ADR} "kill ${BACKEND_PID}"')
                        }
                    } catch (Exception e) {
                        echo "Echec de l'Ã©tape, il n'y avait probablement pas de serveur de lancÃ©"
                    }
                }
                sh "ssh ${SCP_ADR} ls -l"
                sh "ssh ${SCP_ADR} java -jar fimafeng-back-1.0-SNAPSHOT.jar > backend.log 2>&1 &"
            }
        }
    }
}

def getAddressFromBranch(branchName) {
    switch(branchName) {
        case 'main': // PROD
            return "cgl-prod@172.31.250.70"
        case 'preprod': // PRE-PROD
            return "cgl-preprod@172.31.250.67"
        case 'dev':
            return "cgl-preprod@172.31.250.67"
        default:
            return null
    }
}

def getParamFromBranch(branchName) {
    switch(branchName) {
        case 'main':
            return "build:prod"
        case 'dev':
            return "build:preprod"
        case 'preprod':
            return "build:preprod"
        default:
            return "build"
    }
}