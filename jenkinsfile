pipeline {
    agent any

    stages {

        stage ("Initialisation ‚è≥") {
            steps {
                script {
                    adr = getAdressFromBranch(env.BRANCH_NAME)
                }
                echo "Machine Cible: ${adr}"
                sh '''
                    cd ${WORKSPACE}
                    chmod -R 755 ./proto-front
                    chmod -R 755 ./proto-back 
                '''
            }
        }

        stage("Test üß™") {
            steps {
                echo "Lancement des tests BACK"
                sh '''
                    cd ${WORKSPACE}/proto-back/
                    # mvn test
                '''

                echo "Lancement des tests FRONT"
                sh '''
                    cd ${WORKSPACE}/proto-front
                    chmod +x ./node_modules/.bin/react-scripts
                    # chmod -R 755 ./node_modules
                    rm -rf node_modules
                    npm install
                    npx update-browserslist-db@latest
                    npm install --save-dev @babel/plugin-proposal-private-property-in-object
                    npm test --passWithNoTests
                '''
            }
        }

        stage("Package üì¶") {
            steps {

                echo "Compilation du BACK"
                sh '''
                    cd ${WORKSPACE}/proto-back
                    mvn clean package
                '''

                echo "Compilation du FRONT"
                sh '''
                    cd ${WORKSPACE}/proto-front
                    npm run build
                '''
                
            }
        }

        stage("Deliver üöö") {
            steps {
                echo "Livraison des fichiers"
                sh '''
                    cd ${WORKSPACE}
                    scp ./proto-back/target/*.jar ${adr}:backend.jar
                    scp ./proto-front/build/ ${adr}:
                '''
            }
        }

        stage("Start üöÄ") {
            steps {
                echo "D√©marrage des modules"
            }
        }
    }
}

def getAdressFromBranch(branchName) {
    switch(branchName) {
        case 'main': // PROD
            return "cgl-prod@172.31.252.155"

        case 'dev': // PRE-PROD
            return "cgl-preprod@172.31.250.67"
        default:
            return null
    }
}