pipeline {
    agent any

    environment {
        SCP_ADR = getAdressFromBranch(env.BRANCH_NAME)
    }

    stages {

        stage ("Initialisation ‚è≥") {
            steps {
                echo "Environment: ${SCP_ADR}"
                sh '''
                    cd ${WORKSPACE}
                    chmod -R 755 ./fimafeng-front
                    # chmod -R 755 ./fimafeng-back
                '''
            }
        }

        stage("Test üß™") {
            steps {
                echo "Lancement des tests BACK"
                sh '''
                    cd ${WORKSPACE}/fimafeng-back/
                    # mvn test
                '''

                echo "Lancement des tests FRONT"
                sh '''
                    cd ${WORKSPACE}/fimafeng-front
                    #chmod +x ./node_modules/.bin/react-scripts
                    chmod -R 755 ./node_modules
                    rm -rf node_modules
                    npm install
                    npx update-browserslist-db@latest
                    npm install --save-dev @babel/plugin-proposal-private-property-in-object
                    # npm test --passWithNoTests
                '''
            }
        }

        stage("Package üì¶") {
            steps {

                echo "Compilation du BACK"
                sh '''
                    cd ${WORKSPACE}/fimafeng-back
                    mvn clean install
                '''

                echo "Compilation du FRONT"
                sh '''
                    cd ${WORKSPACE}/fimafeng-front
                    npm install react-scripts --save
                    npm run build
                '''
                
            }
        }

        stage("Deliver üöö") {
            steps {
                echo "Livraison des fichiers"
                sh '''
                    cd ${WORKSPACE}
                    scp ./fimafeng-back/target/*.jar ${SCP_ADR}:
                    ssh ${SCP_ADR} rm -r ./build/
                    scp -r ./fimafeng-front/build/ ${SCP_ADR}:
                '''
            }
        }

        stage("Start üöÄ") {
            steps {
                echo "D√©marrage des modules"

                echo "Mise √† jour du front"
                sh '''
                    ssh ${SCP_ADR} rm -r /var/www/html/*
                    ssh ${SCP_ADR} cp -r build/* /var/www/html/
                    '''
                
                echo "Mise √† jour du back"
                script {
                    try {
                        def result = sh(script: 'ssh ${SCP_ADR} "pgrep java"', returnStdout: true).trim()
                        echo "result: [$result]"
                        if (result.size() != '') {
                            env.BACKEND_PID = result
                            sh (script: 'ssh ${SCP_ADR} "kill ${BACKEND_PID}"')
                        }
                    } catch (Exception e) {
                        echo "Echec de l'√©tape, il n'y avait probablement pas de serveur de lanc√©"
                    }
                }
                sh "ssh ${SCP_ADR} ls -l"
                sh "ssh ${SCP_ADR} java -jar fimafeng-back-1.0-SNAPSHOT.jar &"
            }
        }
    }
}

def getAdressFromBranch(branchName) {
    switch(branchName) {
        case 'main': // PROD
            return "cgl-prod@172.31.252.155"

        case 'dev': // PRE-PROD
            return "cgl-preprod@172.31.250.67"
        default:
            return null
    }
}
