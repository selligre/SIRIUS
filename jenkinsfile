pipeline {
    agent any

    environment {
        SCP_ADR = getAdressFromBranch(env.BRANCH_NAME)
    }

    stages {

        stage ("Initialisation ‚è≥") {
            steps {
                echo "\033[0;34mEnvironment: ${SCP_ADR}\033[0m"
                sh '''
                    cd ${WORKSPACE}
                    chmod -R 755 ./proto-front
                    # chmod -R 755 ./proto-back
                '''
            }
        }

        stage("Test üß™") {
            steps {
                echo "\033[0;34mLancement des tests BACK\033[0m"
                sh '''
                    cd ${WORKSPACE}/proto-back/
                    # mvn test
                '''

                echo "\033[0;34mLancement des tests FRONT\033[0m"
                sh '''
                    cd ${WORKSPACE}/proto-front
                    chmod +x ./node_modules/.bin/react-scripts
                    chmod -R 755 ./node_modules
                    rm -rf node_modules
                    npm install
                    npx update-browserslist-db@latest
                    npm install --save-dev @babel/plugin-proposal-private-property-in-object
                    # npm test --passWithNoTests
                '''
            }
        }

        stage("Package üì¶") {
            steps {

                echo "\033[0;34mCompilation du BACK\033[0m"
                sh '''
                    cd ${WORKSPACE}/proto-back
                    mvn clean package
                '''

                echo "\033[0;34mCompilation du FRONT\033[0m"
                sh '''
                    cd ${WORKSPACE}/proto-front
                    npm run build
                '''
                
            }
        }

        stage("Deliver üöö") {
            steps {
                echo "\033[0;34mLivraison des fichiers\033[0m"
                sh '''
                    cd ${WORKSPACE}
                    scp ./proto-back/target/*.jar ${SCP_ADR}:
                    scp -r ./proto-front/build/ ${SCP_ADR}:
                '''
            }
        }

        stage("Start üöÄ") {
            steps {
                echo "\033[0;34mD√©marrage des modules\033[0m"
                sh '''
                    sudo ssh ${SCP_ADR} sudo systemctl restart backend.service
                    sudo ssh ${SCP_ADR} sudo cp -r build/* /var/www/html/
                    sudo ssh ${SCP_ADR} sudo systemctl restart apache2
                '''
            }
        }
    }
}

def getAdressFromBranch(branchName) {
    switch(branchName) {
        case 'main': // PROD
            return "cgl-prod@172.31.252.155"

        case 'dev': // PRE-PROD
            return "cgl-preprod@172.31.250.67"
        default:
            return null
    }
}
